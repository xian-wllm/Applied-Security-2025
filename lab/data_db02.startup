#!/bin/bash
set -euo pipefail
ip -4 addr add 10.50.30.3/24 dev eth0 || true
ip link set eth0 up
ip route add default via 10.50.30.1 || true

iptables -F; iptables -X
iptables -P INPUT DROP; iptables -P FORWARD DROP; iptables -P OUTPUT DROP
iptables -A INPUT -i lo -j ACCEPT; iptables -A OUTPUT -o lo -j ACCEPT
iptables -A INPUT  -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A OUTPUT -m conntrack --ctstate ESTABLISHED,RELATED -j ACCEPT
iptables -A INPUT  -s 10.50.20.20 -p tcp --dport 3306 -j ACCEPT  # guac

iptables -A OUTPUT -o eth0 -p tcp -d 10.50.40.2 --dport 1515 -j ACCEPT  # wazuh agent
iptables -A OUTPUT -o eth0 -p tcp -d 10.50.40.2 --dport 1514 -j ACCEPT  # wazuh agent

# allow SSH IN from Guacamole guacd (jump host)
iptables -A INPUT -p tcp --dport 22 -s 10.50.40.20 -j ACCEPT

# # Create sysadmin user if not present
# id sysadmin >/dev/null 2>&1 || useradd -m -s /bin/bash sysadmin

# mkdir -p ~sysadmin/.ssh
# chmod 700 ~sysadmin/.ssh

# cat /shared/guacd/guac_sysadmin_ed25519.pub >> ~sysadmin/.ssh/authorized_keys

# chown -R sysadmin:sysadmin ~sysadmin/.ssh
# chmod 600 ~sysadmin/.ssh/authorized_keys

# /etc/init.d/ssh start

/var/ossec/bin/wazuh-control start