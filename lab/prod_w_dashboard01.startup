ip -4 addr add 10.50.20.11/24 dev eth0
ip link set eth0 up
ip route del default || true
ip route add default via 10.50.20.1 dev eth0

echo "nameserver 1.1.1.1" >> /etc/resolv.conf

mkdir -p /usr/share/wazuh-dashboard/certs/
mkdir -p /usr/share/wazuh-dashboard/config/

cp /shared/wazuh_indexer_ssl_certs/wazuh.dashboard.pem /usr/share/wazuh-dashboard/certs/wazuh-dashboard.pem
cp /shared/wazuh_indexer_ssl_certs/wazuh.dashboard-key.pem /usr/share/wazuh-dashboard/certs/wazuh-dashboard-key.pem
cp /shared/wazuh_indexer_ssl_certs/root-ca.pem /usr/share/wazuh-dashboard/certs/root-ca.pem
cp /shared/wazuh_dashboard/opensearch_dashboards.yml /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml
cp /shared/wazuh_dashboard/wazuh.yml /usr/share/wazuh-dashboard/data/wazuh/config/wazuh.yml

echo $INDEXER_IP wazuh.indexer >> /etc/hosts
echo $MANAGER_IP wazuh.manager >> /etc/hosts

# Create sysadmin user if not present
id sysadmin >/dev/null 2>&1 || useradd -m -s /bin/bash sysadmin

mkdir -p ~sysadmin/.ssh
chmod 700 ~sysadmin/.ssh

cat /shared/guacd/guac_sysadmin_ed25519.pub >> ~sysadmin/.ssh/authorized_keys

chown -R sysadmin:sysadmin ~sysadmin/.ssh
chmod 600 ~sysadmin/.ssh/authorized_keys

/etc/init.d/ssh start

INSTALL_DIR=/usr/share/wazuh-dashboard
DASHBOARD_USERNAME="${DASHBOARD_USERNAME:-kibanaserver}"
DASHBOARD_PASSWORD="${DASHBOARD_PASSWORD:-kibanaserver}"

# Create and configure Wazuh dashboard keystore

yes | $INSTALL_DIR/bin/opensearch-dashboards-keystore create --allow-root && \
echo $DASHBOARD_USERNAME | $INSTALL_DIR/bin/opensearch-dashboards-keystore add opensearch.username --stdin --allow-root && \
echo $DASHBOARD_PASSWORD | $INSTALL_DIR/bin/opensearch-dashboards-keystore add opensearch.password --stdin --allow-root

##############################################################################
# Start Wazuh dashboard
##############################################################################

/wazuh_app_config.sh $WAZUH_UI_REVISION

/usr/share/wazuh-dashboard/bin/opensearch-dashboards -c /usr/share/wazuh-dashboard/config/opensearch_dashboards.yml --allow-root > /var/log/opensearch.log 2>&1 &